/**
 * Markdown í…œí”Œë¦¿ ì—”ì§„ ìœ í‹¸ë¦¬í‹°
 * ìš”êµ¬ì‚¬í•­: í…œí”Œë¦¿ì„ ì‚¬ìš©í•œ Markdown ë¬¸ì„œ ìƒì„±
 */

import { StoryResponse, StoryDifficulty } from './english-story.types';

/**
 * í…œí”Œë¦¿ ë³€ìˆ˜ íƒ€ì… ì •ì˜
 */
export interface TemplateData {
    title: string;
    date: string;
    difficulty: string;
    difficultyEn: StoryDifficulty;
    wordCount: number;
    words: Array<{
        englishWord: string;
        koreanMeaning: string;
    }>;
    englishStory: string;
    koreanTranslation: string;
}

/**
 * ì‚¬ìš© ê°€ëŠ¥í•œ í…œí”Œë¦¿ ëª©ë¡
 */
export const AVAILABLE_TEMPLATES = {
    default: 'story-default.md',
    study: 'story-study.md',
    progress: 'story-progress.md'
} as const;

export type TemplateType = keyof typeof AVAILABLE_TEMPLATES;

/**
 * ê¸°ë³¸ í…œí”Œë¦¿ ë‚´ìš©ë“¤ (ë¹Œë“œ ì‹œì ì— ë²ˆë“¤ì— í¬í•¨)
 */
const TEMPLATE_CONTENTS: Record<TemplateType, string> = {
    default: `# {{title}}

**ìƒì„±ì¼:** {{date}}  
**ë‚œì´ë„:** {{difficulty}}  
**ì‚¬ìš©ëœ ë‹¨ì–´ ìˆ˜:** {{wordCount}}ê°œ

---

## ğŸ“š ì‚¬ìš©ëœ ë‹¨ì–´ë“¤

{{#each words}}
- **{{englishWord}}**: {{koreanMeaning}}
{{/each}}

---

## ğŸ“– ì˜ì–´ ìŠ¤í† ë¦¬

{{englishStory}}

---

## ğŸ‡°ğŸ‡· í•œêµ­ì–´ í•´ì„

{{koreanTranslation}}

---

*ì´ ë¬¸ì„œëŠ” AI Solution Hubì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`,

    study: `# Study Notes: {{title}}

Generated on {{date}} | Difficulty: {{difficulty}}

## Vocabulary ({{wordCount}} words)

{{#each words}}
| {{englishWord}} | {{koreanMeaning}} |
{{/each}}

## English Story

> {{englishStory}}

## Korean Translation

> {{koreanTranslation}}

---

### Study Tips

- Practice reading the story aloud
- Try to use these words in your own sentences
- Review the vocabulary regularly

*Generated by AI Solution Hub*`,

    progress: `---
title: "{{title}}"
date: "{{date}}"
difficulty: "{{difficulty}}"
wordCount: {{wordCount}}
tags: [english, story, vocabulary]
---

## Vocabulary

{{#each words}}
- [ ] **{{englishWord}}** - {{koreanMeaning}}
{{/each}}

## Story

{{englishStory}}

## Translation

{{koreanTranslation}}

## Progress Tracking

- [ ] Read the story
- [ ] Understand all vocabulary
- [ ] Practice pronunciation
- [ ] Use words in sentences`
};

/**
 * ê°„ë‹¨í•œ í…œí”Œë¦¿ ì—”ì§„ êµ¬í˜„
 * Handlebars ìŠ¤íƒ€ì¼ì˜ ë³€ìˆ˜ ì¹˜í™˜ê³¼ ë°˜ë³µë¬¸ ì§€ì›
 */
class SimpleTemplateEngine {
    /**
     * í…œí”Œë¦¿ì„ ë Œë”ë§í•©ë‹ˆë‹¤
     */
    render(template: string, data: TemplateData): string {
        let result = template;

        // ë°˜ë³µë¬¸ ì²˜ë¦¬ ({{#each words}}...{{/each}})
        result = this.processEachBlocks(result, data);

        // ë‹¨ìˆœ ë³€ìˆ˜ ì¹˜í™˜ ({{variableName}})
        result = this.processVariables(result, data);

        return result;
    }

    /**
     * {{#each}} ë¸”ë¡ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤
     */
    private processEachBlocks(template: string, data: TemplateData): string {
        const eachRegex = /\{\{#each\s+(\w+)\}\}([\s\S]*?)\{\{\/each\}\}/g;

        return template.replace(eachRegex, (match, arrayName, blockContent) => {
            const arrayData = data[arrayName as keyof TemplateData];

            if (!Array.isArray(arrayData)) {
                return '';
            }

            return arrayData.map(item => {
                let itemContent = blockContent;

                // ë°°ì—´ ì•„ì´í…œì˜ ì†ì„±ë“¤ì„ ì¹˜í™˜
                if (typeof item === 'object' && item !== null) {
                    for (const [key, value] of Object.entries(item)) {
                        const regex = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
                        itemContent = itemContent.replace(regex, String(value));
                    }
                }

                return itemContent;
            }).join('');
        });
    }

    /**
     * ë‹¨ìˆœ ë³€ìˆ˜ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤
     */
    private processVariables(template: string, data: TemplateData): string {
        const variableRegex = /\{\{(\w+)\}\}/g;

        return template.replace(variableRegex, (match, variableName) => {
            const value = data[variableName as keyof TemplateData];
            return value !== undefined ? String(value) : match;
        });
    }
}

/**
 * StoryResponseë¥¼ TemplateDataë¡œ ë³€í™˜í•©ë‹ˆë‹¤
 */
export function storyToTemplateData(story: StoryResponse): TemplateData {
    const difficultyMap: Record<StoryDifficulty, string> = {
        easy: 'ì‰¬ì›€',
        medium: 'ë³´í†µ',
        hard: 'ì–´ë ¤ì›€'
    };

    return {
        title: 'ì˜ì–´ ìŠ¤í† ë¦¬',
        date: new Date().toLocaleDateString('ko-KR'),
        difficulty: difficultyMap[story.difficulty],
        difficultyEn: story.difficulty,
        wordCount: story.usedWords.length,
        words: story.usedWords,
        englishStory: stripHtmlTags(story.englishStory),
        koreanTranslation: story.koreanTranslation
    };
}

/**
 * HTML íƒœê·¸ë¥¼ ì œê±°í•©ë‹ˆë‹¤
 */
function stripHtmlTags(html: string): string {
    return html.replace(/<[^>]*>/g, '');
}

/**
 * í…œí”Œë¦¿ì„ ì‚¬ìš©í•˜ì—¬ Markdown ì½˜í…ì¸ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
 */
export function generateMarkdownFromTemplate(
    story: StoryResponse,
    templateType: TemplateType = 'default'
): string {
    const engine = new SimpleTemplateEngine();
    const template = TEMPLATE_CONTENTS[templateType];
    const data = storyToTemplateData(story);

    return engine.render(template, data);
}

/**
 * ì‚¬ìš© ê°€ëŠ¥í•œ í…œí”Œë¦¿ ëª©ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤
 */
export function getAvailableTemplates(): Array<{
    key: TemplateType;
    name: string;
    description: string;
}> {
    return [
        {
            key: 'default',
            name: 'ê¸°ë³¸ í…œí”Œë¦¿',
            description: 'ê¸°ë³¸ì ì¸ ìŠ¤í† ë¦¬ í˜•ì‹ìœ¼ë¡œ êµ¬ì„±ëœ í…œí”Œë¦¿'
        },
        {
            key: 'study',
            name: 'í•™ìŠµìš© í…œí”Œë¦¿',
            description: 'í•™ìŠµ íŒê³¼ êµ¬ì¡°í™”ëœ í˜•ì‹ì˜ í…œí”Œë¦¿'
        },
        {
            key: 'progress',
            name: 'ì§„ë„ ê´€ë¦¬ í…œí”Œë¦¿',
            description: 'ì²´í¬ë¦¬ìŠ¤íŠ¸ì™€ ë©”íƒ€ë°ì´í„°ë¥¼ í¬í•¨í•œ í…œí”Œë¦¿'
        }
    ];
}
